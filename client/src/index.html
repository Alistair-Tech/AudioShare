<!DOCTYPE html>
<html>
  <style>
    #hero {
      width: 100%;
      height: 100vh;
      background-image: url("/static/hero-bg.png");
      position: relative;
      color: black;
    }
  </style>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audio Share</title>
    <link
      rel="stylesheet"
      href="https://v4-alpha.getbootstrap.com/dist/css/bootstrap.min.css"
    />
    <script src="https://unpkg.com/ipfs-http-client/dist/index.min.js"></script>
  </head>

  <body>
    <div id="hero">
      <div align="center" id="1" class="container"></div>
    </div>
  </body>
  <script type="text/javascript">
    var selected = 0;
    var rec;
    function loadDiv() {
      divToRender = document.getElementById("1");
      if (!selected) {
        divToRender.innerHTML += `
         <h2>AudioShare</h2>
        <p>A web app to record and share audio on IPFS</p>
            <button onClick=setSelected(1)>Share Audio</button>
        <button onClick=setSelected(2)>Retrieve Audio</button>
         `;
      } else if (selected == 1) {
        divToRender.innerHTML = `
         <h2>AudioShare</h2>
        <p>A web app to record and share audio on IPFS</p>
        <button id="start" onClick=handleRecording("start")>Start Recording</button>
        <button id="stop" onClick=handleRecording("stop")>Stop Recording</button>
           `;
        loadAudio();
      }
    }
    function setSelected(id) {
      selected = id;
      loadDiv();
    }
    function handleRecording(id) {
      let start = document.getElementById("start");
      let stop = document.getElementById("stop");
      if (id == "start") {
        start.disabled = true;
        stop.disabled = false;
        audioChunks = [];
        rec.start();
      } else {
        rec.stop();
        audioChunks = [];
        stop.disabled = true;
        start.disabled = false;
      }
    }
    function loadAudio() {
      navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
        audioHandler(stream);
      });
    }
    function audioHandler(stream) {
      rec = new MediaRecorder(stream);
      rec.ondataavailable = (e) => {
        audioChunks.push(e.data);
        if (rec.state == "inactive") {
          let blob = new Blob(audioChunks, { type: "audio/mpeg-3" });
          if (
            window.confirm(
              "Are you sure that you want to share the audio on IPFS?"
            )
          ) {
            shareIPFS(blob);
          }
        }
      };
    }
    function shareIPFS(blob) {
      const ipfs = window.IpfsHttpClient("localhost", "5001");
      try {
        const results = ipfs.add(blob);
      } catch (e) {
        console.log(e);
      }
      window.alert("Successfully shared the audio with hash" + results.hash);
    }
    loadDiv();
  </script>
</html>
